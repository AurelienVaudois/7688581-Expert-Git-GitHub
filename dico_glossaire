import os
import json
import glob

def charger_glossaire_depuis_dossier(chemin_dossier):
    """
    Lit tous les fichiers .json dans le dossier et fusionne les r√®gles.
    Retourne un dictionnaire : { "CODE_POUVOIR": ["phrase 1", "phrase 2"] }
    """
    glossaire_global = {}
    
    # On cherche tous les fichiers .json
    fichiers = glob.glob(os.path.join(chemin_dossier, "*.json"))
    print(f"üìÇ Chargement de {len(fichiers)} fichiers de d√©finition...")

    for fichier in fichiers:
        try:
            with open(fichier, 'r', encoding='utf-8') as f:
                content = json.load(f)
                
                # Le contenu est suppos√© √™tre : {"CODE": ["liste", "phrases"]}
                for code_pouvoir, phrases_associees in content.items():
                    # On nettoie les phrases (strip) pour √™tre propre
                    clean_phrases = [p.strip() for p in phrases_associees if isinstance(p, str)]
                    
                    if code_pouvoir in glossaire_global:
                        # Si le code existe d√©j√† (ex: r√©parti sur 2 fichiers), on √©tend la liste
                        glossaire_global[code_pouvoir].extend(clean_phrases)
                    else:
                        glossaire_global[code_pouvoir] = clean_phrases
                        
        except Exception as e:
            print(f"‚ö†Ô∏è Erreur lecture fichier {os.path.basename(fichier)} : {e}")

    print(f"‚úÖ Glossaire charg√© : {len(glossaire_global)} codes pouvoirs identifi√©s.")
    return glossaire_global

# --- TEST ---
# Remplacez par le chemin de votre dossier contenant les JSONs
# DOSSIER_GLOSSAIRE = "/mnt/data/PROCURATION_LIBRE/GLOSSAIRE"
# glossaire = charger_glossaire_depuis_dossier(DOSSIER_GLOSSAIRE)


++++++++++++

def generer_prompt_mapping(glossaire_dict):
    """
    Transforme le dictionnaire en texte d'instruction pour le System Prompt.
    """
    prompt_text = "\n### üß† R√àGLES DE MAPPING S√âMANTIQUE (GLOSSAIRE M√âTIER) ###\n"
    prompt_text += "Tu ne dois pas deviner. Tu dois utiliser ce dictionnaire pour traduire le texte du PDF en CODE STANDARD.\n\n"
    
    for code, phrases in glossaire_dict.items():
        # On formatte pour que ce soit lisible par l'IA
        # On limite √† 50 synonymes par code pour √©viter de saturer le context inutilement
        top_phrases = phrases[:50] 
        liste_txt = ", ".join([f'"{p}"' for p in top_phrases])
        
        prompt_text += f"üîµ Si tu lis : {liste_txt}\n"
        prompt_text += f"   üëâ Alors le pouvoir est : {code}\n\n"
        
    prompt_text += "### FIN DES R√àGLES ###\n"
    return prompt_text

+++++++++ enum +++++++

from enum import Enum

# Cr√©ation dynamique de l'Enum bas√©e sur les cl√©s de vos fichiers JSON
# Cela garantit que Pydantic acceptera tout ce qui est d√©fini dans vos fichiers
ListeCodes = Enum('CodePouvoir', {k: k for k in mon_glossaire.keys()})

# Utilisation dans le mod√®le Pydantic
class PouvoirStandardise(BaseModel):
    categorie_standard: ListeCodes = Field(...) # Utilise l'Enum dynamique
    # ...

