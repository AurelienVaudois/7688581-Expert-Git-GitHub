import base64
from openai import OpenAI
from pdf2image import convert_from_path
import io

# 1. CONFIGURATION DU CLIENT
# On pointe vers le serveur local vLLM
client = OpenAI(
    base_url="http://localhost:8000/v1",
    api_key="EMPTY" # vLLM ne requiert pas de cl√© par d√©faut
)

def encode_image_base64(pil_image):
    """Convertit une image PIL en cha√Æne base64."""
    buffered = io.BytesIO()
    # JPEG est plus l√©ger pour le transport r√©seau que PNG
    pil_image.save(buffered, format="JPEG", quality=95)
    return base64.b64encode(buffered.getvalue()).decode('utf-8')

def analyze_procuration(pdf_path):
    print(f"--- Lecture de : {pdf_path} ---")
    
    # Conversion PDF -> Image (Page 1)
    try:
        images = convert_from_path(pdf_path, dpi=200)
        image_base64 = encode_image_base64(images[0])
    except Exception as e:
        print(f"Erreur image: {e}")
        return

    # Le Prompt Syst√®me
    system_prompt = "Tu es un expert en extraction de donn√©es bancaires. Extrais les informations au format JSON strict."
    
    # Le Prompt Utilisateur
    user_prompt = """
    Analyse cette procuration.
    Extrais un JSON avec les champs : 
    - mandant (nom, date_naissance)
    - mandataire (nom)
    - societe (siren, raison_sociale)
    - pouvoirs (liste des pouvoirs, plafonds, conditions de signature).
    """

    print("--- Envoi de la requ√™te au serveur vLLM ---")
    
    # Appel API standard OpenAI
    response = client.chat.completions.create(
        model="Qwen/Qwen2-VL-72B-Instruct-AWQ", # Le nom doit matcher celui lanc√© dans vLLM
        messages=[
            {"role": "system", "content": system_prompt},
            {
                "role": "user",
                "content": [
                    {
                        "type": "text", 
                        "text": user_prompt
                    },
                    {
                        "type": "image_url",
                        "image_url": {
                            # Format standard OpenAI Vision
                            "url": f"data:image/jpeg;base64,{image_base64}"
                        },
                    },
                ],
            }
        ],
        temperature=0.1,
        max_tokens=2048,
        # Astuce : Pour forcer le JSON c√¥t√© client si vLLM le supporte mal en VLM
        response_format={"type": "json_object"} 
    )

    result = response.choices[0].message.content
    print("\n--- R√©ponse du Mod√®le ---\n")
    print(result)

if __name__ == "__main__":
    analyze_procuration("exemple_procuration.pdf")

--------------

import os
import io
import base64
import json
from openai import OpenAI
from pdf2image import convert_from_path
from IPython.display import display, JSON, Image as IPImage

# ---------------- CONFIGURATION ----------------
# Remplacez par l'IP de votre instance GPU ou "localhost" si tunnel SSH
# L'endpoint vLLM est compatible OpenAI
API_URL = "http://localhost:8000/v1" 
API_KEY = "EMPTY" # vLLM n'exige pas de cl√© par d√©faut
MODEL_NAME = "Qwen/Qwen2-VL-72B-Instruct-AWQ" # Doit correspondre exactement au nom lanc√© sur le serveur

client = OpenAI(base_url=API_URL, api_key=API_KEY)

# ---------------- FONCTIONS UTILITAIRES ----------------

def pdf_page_to_base64(pdf_path, page_num=0, dpi=200):
    """
    Convertit une page PDF en base64 pour l'envoi API.
    Retourne aussi l'objet image pour affichage local.
    """
    try:
        # Conversion PDF -> Image (RAM locale)
        images = convert_from_path(pdf_path, dpi=dpi)
        if page_num >= len(images):
            raise ValueError("Num√©ro de page hors limites")
        
        pil_image = images[page_num]
        
        # Encodage en JPEG (plus l√©ger que PNG pour le r√©seau)
        buff = io.BytesIO()
        pil_image.save(buff, format="JPEG", quality=95)
        b64_string = base64.b64encode(buff.getvalue()).decode("utf-8")
        
        return pil_image, b64_string
    except Exception as e:
        print(f"Erreur conversion image: {e}")
        return None, None

def extract_data_remote(pdf_path):
    print(f"üì° Traitement de : {pdf_path}")
    
    # 1. Pr√©paration de l'image
    img, img_b64 = pdf_page_to_base64(pdf_path)
    if not img_b64: return
    
    # Affichage de contr√¥le dans le notebook
    print("Document envoy√© au mod√®le :")
    display(img.resize((300, 400))) # Miniature

    # 2. D√©finition du Prompt
    system_prompt = "Tu es un expert juridique. Extrais les donn√©es au format JSON strict."
    user_prompt = """
    Analyse cette procuration bancaire.
    Extrais un JSON structur√© contenant :
    - objet_procuration
    - societe (raison_sociale, siren)
    - mandant (nom, date_naissance)
    - mandataire (nom, date_naissance)
    - pouvoirs (liste d√©taill√©e avec : type, comptes_concernes, plafond, strategie_signature).
    
    Pour la strat√©gie de signature, pr√©cise si c'est SEULE ou CONJOINTE.
    Si un SIREN est pr√©sent dans un tampon, lis-le.
    """

    # 3. Appel API vers l'instance GPU
    try:
        response = client.chat.completions.create(
            model=MODEL_NAME,
            messages=[
                {"role": "system", "content": system_prompt},
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": user_prompt},
                        {
                            "type": "image_url",
                            "image_url": {"url": f"data:image/jpeg;base64,{img_b64}"},
                        },
                    ],
                }
            ],
            temperature=0.01, # Tr√®s faible pour la stabilit√© du JSON
            max_tokens=2048,
            extra_body={"guided_json": "json_object"} # Optionnel: aide vLLM si activ√©
        )
        
        # 4. Traitement de la r√©ponse
        raw_content = response.choices[0].message.content
        
        # Nettoyage des balises markdown √©ventuelles
        clean_json = raw_content.replace("```json", "").replace("```", "").strip()
        
        data = json.loads(clean_json)
        return data

    except Exception as e:
        print(f"‚ùå Erreur API : {e}")
        return None

# ---------------- EXECUTION ----------------
mon_pdf = "exemple_procuration.pdf" # Assurez-vous que ce fichier est dans votre workspace local

if os.path.exists(mon_pdf):
    resultat = extract_data_remote(mon_pdf)
    if resultat:
        print("\n‚úÖ Extraction r√©ussie :")
        display(JSON(resultat)) # Affichage interactif
else:
    print(f"Fichier {mon_pdf} introuvable localement.")
